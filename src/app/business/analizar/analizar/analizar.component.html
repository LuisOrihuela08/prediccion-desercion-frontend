<div class="container">
  <div class="card">
    <header class="card-header">
      <h1 class="title">ğŸ“ PredicciÃ³n de DeserciÃ³n Estudiantil</h1>
      <p class="subtitle">Ingresa los datos para evaluar el riesgo de deserciÃ³n.</p>
    </header>

    <!-- Mensaje de error si ocurre -->
    <div *ngIf="errorMessage" class="message error-message">
      <p><strong>Error:</strong> {{ errorMessage }}</p>
    </div>

    <!-- Formulario: se muestra cuando ya cargÃ³ la metadata -->
    <form *ngIf="predictionForm" [formGroup]="predictionForm" (ngSubmit)="onSubmit()">

      <!-- SecciÃ³n: Datos AcadÃ©micos y Financieros -->
      <div *ngIf="numericalFeatures.length > 0">
        <h2 class="section-title">ğŸ“Š Datos AcadÃ©micos y Financieros</h2>
        <div class="form-grid">
          <div class="form-group" *ngFor="let feature of numericalFeatures">
            <label [for]="feature.sanitizedName">{{ feature.name }}:</label>
            <input
              [id]="feature.sanitizedName"
              [type]="feature.name.includes('Porcentaje') ? 'range' : 'number'"
              [min]="feature.name.includes('Porcentaje') ? 0 : null"
              [max]="feature.name.includes('Porcentaje') ? 100 : null"
              [step]="feature.name.includes('Porcentaje') ? 0.1 : 'any'"
              [formControlName]="feature.sanitizedName"
              class="input-field">

            <span *ngIf="feature.name.includes('Porcentaje')" class="range-value">
              {{ predictionForm.get(feature.sanitizedName)?.value }}%
            </span>

            <small
              *ngIf="predictionForm.get(feature.sanitizedName)?.hasError('required') && predictionForm.get(feature.sanitizedName)?.touched"
              class="text-danger">
              Este campo es requerido.
            </small>
          </div>
        </div>
        <hr class="divider">
      </div>

      <!-- SecciÃ³n: Datos Personales y de Contexto -->
      <h2 class="section-title">ğŸ‘¤ Datos Personales y de Contexto</h2>
      <div class="form-grid">
        <div class="form-group" *ngFor="let feature of categoricalFeatures">
          <label [for]="feature.sanitizedName">{{ feature.name }}:</label>
          <select [id]="feature.sanitizedName" [formControlName]="feature.sanitizedName" class="select-field">
            <option *ngFor="let val of feature.allowed_values" [value]="val">
              {{ val }}
            </option>
          </select>
          <small
            *ngIf="predictionForm.get(feature.sanitizedName)?.hasError('required') && predictionForm.get(feature.sanitizedName)?.touched"
            class="text-danger">
            Este campo es requerido.
          </small>
        </div>
      </div>

      <!-- BotÃ³n de predicciÃ³n -->
      <div class="form-actions">
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="isLoading">
          <span *ngIf="!isLoading">ğŸ”® Predecir DeserciÃ³n</span>
          <span *ngIf="isLoading">â³ Analizando...</span>
        </button>
      </div>
    </form>

    <!-- Mensaje de carga inicial (solo mientras carga metadata) -->
    <div *ngIf="!predictionForm && !errorMessage" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando formulario...</p>
    </div>

    <!-- Resultado de la predicciÃ³n -->
    <div *ngIf="predictionResult" class="card-footer">
      <hr class="divider">
      <h2 class="section-title">ğŸ“Š Resultado de la PredicciÃ³n</h2>
      <div class="result-box"
        [ngClass]="{'desertor': predictionResult.y_pred === 1, 'no-desertor': predictionResult.y_pred === 0}">
        <p class="result-label">
          {{ predictionResult.y_pred === 1 ? 'âš ï¸ ALTO RIESGO DE DESERCIÃ“N' : 'âœ… BAJO RIESGO DE DESERCIÃ“N' }}
        </p>
        <p><strong>Clase Predicha:</strong> {{ predictionResult.label }}</p>
        <p><strong>Probabilidad de Desertar:</strong> {{ (predictionResult.prob_deserto * 100).toFixed(2) }}%</p>
      </div>
    </div>
  </div>
</div>
